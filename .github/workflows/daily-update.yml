name: Daily Database Update

on:
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger from GitHub UI

jobs:
  update-database:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      contents: write # Allow committing progress back to repo
    
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Determine Last Run Date
        id: get_date
        run: |
          # Default to Jan 13, 2026 at 03:00 UTC if no file exists
          DEFAULT_DATE="2026-01-13T03:00:00Z"
          
          if [ -f .github/daily-update-last-run.txt ]; then
            LAST_RUN=$(cat .github/daily-update-last-run.txt)
            echo "Found last run date: $LAST_RUN"
            echo "FROM_DATE=$LAST_RUN" >> $GITHUB_ENV
          else
            echo "No last run file found. Using default: $DEFAULT_DATE"
            echo "FROM_DATE=$DEFAULT_DATE" >> $GITHUB_ENV
          fi

      - name: Run State Bills Update
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          OPENSTATES_API_KEY: ${{ secrets.OPENSTATES_API_KEY }}
          UPDATED_SINCE: ${{ env.FROM_DATE }}
        run: |
          echo "Fetching state bill updates since: $FROM_DATE"
          # updateStateBills.ts uses its own progress tracking, not the FROM_DATE
          # It will pick up where it left off automatically
          npx tsx src/scripts/updateStateBills.ts

      - name: Run Daily Update Script
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          OPENSTATES_API_KEY: ${{ secrets.OPENSTATES_API_KEY }}
          US_CONGRESS_API_KEY: ${{ secrets.US_CONGRESS_API_KEY }}
          US_CONGRESS_API_KEY_BACKUP_1: ${{ secrets.US_CONGRESS_API_KEY_BACKUP_1 }}
          US_CONGRESS_API_KEY_BACKUP_2: ${{ secrets.US_CONGRESS_API_KEY_BACKUP_2 }}
        run: |
          echo "Running daily updates for votes, legislators, and executive orders"
          npx tsx src/scripts/dailyUpdate.ts

      - name: Generate AI Summaries for New Bills
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
        run: |
          echo "Generating AI summaries for bills without summaries (2024+)"
          npx tsx src/scripts/generateMissingSummaries.ts


      - name: Update Last Run Timestamp
        if: success()
        run: |
          # Save current UTC time as next run's start time
          date -u +"%Y-%m-%dT%H:%M:%SZ" > .github/daily-update-last-run.txt

      - name: Commit and Push Progress
        if: success()
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "actions@github.com"
          git add .github/daily-update-last-run.txt data/state-update-progress.json data/congress-update-progress.json
          # Only commit if there are changes
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update daily digest timestamps and progress files" && git push)

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: update-logs-${{ github.run_number }}
          path: |
            data/daily_update_state.json
            data/state-update-progress.json
          retention-days: 7
